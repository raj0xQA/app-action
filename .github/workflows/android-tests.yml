name: Android App Automation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

    # Cancels all previous workflow runs for pull requests that have not completed.
concurrency:
  # The concurrency group contains the workflow name and the branch name for pull requests or the commit hash for any other events.
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: true

# workflow permissions
permissions:
  checks: write
  contents: write
  issues: write
  pull-requests: write

# workflow environment variables
env:
  FORCE_COLOR: 1
  SHA: ${{ github.event.pull_request.head.sha }}
  LOCAL_APP: ./apk/test.apk
  SENDGRID_FROM: ${{secrets.SENDGRID_FROM}}
  SENDGRID_HOST: ${{secrets.SENDGRID_HOST}}
  SENDGRID_PORT: ${{secrets.SENDGRID_PORT}}
  SENDGRID_USER: ${{secrets.SENDGRID_USER}}
  SENDGRID_PASS: ${{secrets.SENDGRID_PASS}}
  GITHUB_TOKEN: ${{ secrets.GT_TOKEN }}

jobs:
  test:
    name: app test
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # - name: Checkout testing repo
      #   uses: actions/checkout@v4

      # - name: Use desired version of NodeJS
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: 24
      #     cache: npm

      - name: â¬‡ï¸ Download Test APK
        # continue-on-error: true
        run: |
          gh release download 1.0.0 \
          --repo raj0xQA/app-action \
          --pattern "bstack.apk" \
          --dir "apk" \
          --clobber

      - name: Verify APK existence
        # continue-on-error: true
        run: |
          if [ -f "apk/chatway.apk" ]; then
            echo "âœ… APK found! Proceeding..."
            ls -lh apk/chatway.apk
          else
            echo "âŒ Error: APK not found at apk/chatway.apk"
            exit 1
          fi

      # - name: â¬‡ï¸ Check Downloaded Test APK
      #   continue-on-error: true
      #   run: |
      #     ls -lh apk/bstack.apk

      # - name: Install Dependencies
      #   run: |
      #     npm ci || npm i
      # - name: Run tests
      #   run: |
      #     npm run test

      # - name: ðŸ“Š Generate Test report
      #   run: |
      #     npm run report:generate
      #     ls -lh allure-report

      # - name: ðŸš€ Deploy Allure Report to GitHub Pages
      #   if: always()
      #   uses: peaceiris/actions-gh-pages@v4
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./allure-report








      # - name: Enable KVM
      #   run: |
      #     echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
      #     sudo udevadm control --reload-rules
      #     sudo udevadm trigger --name-match=kvm

      # - name: AVD cache
      #   uses: actions/cache@v4
      #   id: avd-cache
      #   with:
      #     path: |
      #       ~/.android/avd/*
      #       ~/.android/adb*
      #     key: avd-cache-34

      # - name: create AVD and generate snapshot for caching
      #   if: steps.avd-cache.outputs.cache-hit != 'true'
      #   uses: reactivecircus/android-emulator-runner@v2
      #   with:
      #     api-level: 34
      #     target: google_atd
      #     arch: x86_64
      #     channel: stable
      #     force-avd-creation: true
      #     disable-animations: false
      #     emulator-options: -no-window -noaudio -no-boot-anim -gpu swiftshader_indirect
      #     script: echo "Generated AVD snapshot for caching."

      # - name: run tests
      #   id: emulator
      #   uses: reactivecircus/android-emulator-runner@v2
      #   with:
      #     api-level: 29
      #     # target: google_atd
      #     # arch: x86_64
      #     # channel: stable
      #     # force-avd-creation: false
      #     # disable-animations: true
      #     # disable-spellchecker: true
      #     emulator-options: -no-snapshot-save -no-window -noaudio -no-boot-anim -gpu swiftshader_indirect -camera-back none
      #     script: |
      #       echo "Emulator started and boot completed!" && set +e && true; EXIT_CODE=$?; set -e; echo "wdio_exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT; exit $EXIT_CODE


    #   - name: âœ‰ï¸ Send Email Notification on Failure
    #     if: always() && failure() && (steps.emulator.outcome == 'skipped') || (steps.emulator.outcome == 'failure' && steps.emulator.outputs.wdio_exit_code == '')
    #     id: emaild
    #     run: |
    #       echo "ðŸ“§ Mail sent"
    #       echo "steps.emulator.outcome = ${{ steps.emulator.outcome }}"
    #       echo "steps.emulator.outcome.outputs = ${{ steps.emulator.outcome.outputs }}"



    # # if: failure() && steps.emulator.outcome == 'failure' || steps.emulator.outcome == 'failure' && steps.emulator.outputs.wdio_exit_code == ''

    # # - name: Archive test artifacts (screenshots, HTML snapshots, Reports)
    # #   if: always()
    # #   uses: actions/upload-artifact@v4
    # #   with:
    # #     name: test-artifact
    # #     path: |
    # #       screencasts
    # #     if-no-files-found: ignore
    # #     retention-days: 1

    # # script: |
    # # echo "Emulator started and boot completed!" && set +e && npx wdio run wdio.conf.js; EXIT_CODE=$?; set -e; echo "wdio_exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT; exit $EXIT_CODE

    # # - name: Check WDIO result
    # #   if: always()
    # #   run: |
    # #     echo "WDIO exit code: ${{ steps.emu.outputs.wdio_exit_code}}"
    # #     echo "WDIO exit code: ${{ steps.emu.outcome }}"

    # # - name: Send Email
    # #   if: failure() && steps.emu.outcome == 'failure' && steps.emu.outputs.wdio_exit_code == ''
    # #   run: |
    # #     node ./utils/sendAcionfailMail.js

    # # - name: Handle emulator failure
    # #   if: failure() && steps.emu.outcome == 'failure' && steps.emu.outputs.wdio_exit_code == ''
    # #   run: |
    # #     echo "Step failed due to emulator issues (not test failures)"

    # # - name: Handle emulator failure
    # #   if: failure() && steps.emu.outcome == 'failure' && steps.emu.outputs.wdio_exit_code == '1'
    # #   run: |
    # #     echo "test failed(not test failures)"
